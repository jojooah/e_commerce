<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jojo.ecommerce.adapter.out.persistence.UserCouponMapper">

    <resultMap id="UserCouponResult" type="com.jojo.ecommerce.domain.model.UserCoupon">
        <id     property="userId"      column="user_id"/>
        <id     property="couponId"    column="coupon_id"/>
        <result property="campaignId"  column="campaign_id"/>
        <result property="useYn"        column="use_yn"/>
        <result property="regDate"     column="reg_date"/>
        <result property="updDate"     column="upd_date"/>
    </resultMap>

    <select id="selectUserCoupon" resultMap="UserCouponResult">
        SELECT
            user_id
          , coupon_id
          , campaign_id
          , use_yn
          , reg_date
          , upd_date
        FROM user_coupon
        WHERE user_id = #{userId}
        AND coupon_id = #{couponId}
        FOR UPDATE
    </select>

    <insert id="insertUserCoupon" parameterType="com.jojo.ecommerce.domain.model.UserCoupon">
        INSERT INTO user_coupon (
            user_id
          , coupon_id
          , use_yn
          , reg_date
        )
        VALUES (
            #{userId}
          , #{couponId}
          , #{useYn}
          , NOW()
        )
    </insert>

    <update id="updateUserCoupon" parameterType="com.jojo.ecommerce.domain.model.UserCoupon">
        UPDATE user_coupon
        SET
            use_yn = #{useYn}
          , upd_date = NOW()
        WHERE user_id = #{userId}
        AND coupon_id = #{couponId}
    </update>

    <select id="existsUserCoupon" resultType="int">
        SELECT COUNT(1)
        FROM user_coupon
        WHERE user_id = #{userId}
        AND coupon_id = #{couponId}
        FOR UPDATE
    </select>

</mapper>
