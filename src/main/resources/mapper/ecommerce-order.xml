<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jojo.ecommerce.adapter.out.persistence.OrderMapper">

    <resultMap id="ItemResult" type="com.jojo.ecommerce.domain.model.OrderItem">
        <id column="order_item_id"    property="orderItemId"/>
        <result column="order_id"   property="orderId"/>
        <result column="product_id" property="productId"/>
        <result column="unit_price" property="unitPrice"/>
        <result column="quantity"   property="quantity"/>
        <result column="reg_date"   property="regDate"/>
        <result column="upd_date"   property="updDate"/>
    </resultMap>

    <resultMap id="OrderItemResult" type="com.jojo.ecommerce.domain.model.OrderItem">
        <id column="item_id"    property="itemId"/>
        <result column="order_id"   property="orderId"/>
        <result column="product_id" property="productId"/>
        <result column="quantity"   property="quantity"/>
        <result column="price"      property="price"/>
        <result column="reg_date"   property="regDate"/>
        <result column="upd_date"   property="updDate"/>
    </resultMap>

    <resultMap id="OrderResult" type="com.jojo.ecommerce.domain.model.Order">
        <id column="order_id"   property="orderId"/>
        <result column="user_id"    property="userId"/>
        <result column="reg_date"   property="regDate"/>
        <result column="payment_status" property="paymentStatus" javaType="com.jojo.ecommerce.domain.model.STATUS_TYPE" typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result column="upd_date"   property="updDate"/>
        <collection property="orderItems" ofType="com.jojo.ecommerce.domain.model.OrderItem" resultMap="OrderItemResult"/>
    </resultMap>

    <select id="selectItemsByOrderId" resultMap="ItemResult" parameterType="long">
        SELECT
            order_item_id
          , order_id
          , product_id
          , unit_price
          , quantity
          , reg_date
          , upd_date
        FROM order_item
        WHERE order_id = #{orderId}
    </select>

    <select id="selectOrderById" resultMap="OrderResult" parameterType="long">
        SELECT o.order_id,
               o.user_id,
               o.reg_date,
               o.upd_date,
               i.order_item_id,
               i.product_id,
               i.quantity,
               i.unit_price,
               i.reg_date AS reg_date,
               i.upd_date AS upd_date
        FROM orders o
                 LEFT JOIN order_item i ON o.order_id = i.order_id
        WHERE o.order_id = #{orderId}
    </select>


    <insert id="insertOrder" parameterType="com.jojo.ecommerce.domain.model.Order" useGeneratedKeys="true" keyProperty="orderId">
        INSERT INTO orders(
            user_id
          , payment_status
          , reg_date
        ) VALUES (
            #{userId}
          , #{paymentStatus}
          , NOW()
        )
    </insert>

    <update id="updateOrder" parameterType="com.jojo.ecommerce.domain.model.Order">
        UPDATE orders
        SET payment_status = #{paymentStatus},
            upd_date = NOW()
        WHERE order_id = #{orderId}
    </update>

    <insert id="insertOrderItem" parameterType="com.jojo.ecommerce.domain.model.OrderItem" useGeneratedKeys="true" keyProperty="orderItemId">
        INSERT INTO order_item (
            order_id
          , product_id
          , unit_price
          , quantity
          , reg_date
        )
        VALUES (
            #{orderId}
          , #{productId}
          , #{unitPrice}
          , #{quantity}
          , NOW()
        )
    </insert>

    <delete id="deleteItemsByOrderId" parameterType="long">
        DELETE
        FROM order_item
        WHERE order_id = #{orderId}
    </delete>

</mapper>
