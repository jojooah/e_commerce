<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jojo.ecommerce.adapter.out.persistence.myBatis.mapper.PointMapper">

    <resultMap id="PointMap" type="com.jojo.ecommerce.domain.model.Point">
        <id column="point_id"   property="pointId"/>
        <result column="user_id"    property="userId"/>
        <result column="point"      property="point"/>
        <result column="request_id" property="requestId"/>
        <result column="reg_date"   property="regDate"/>
        <result column="upd_date"   property="updDate"/>
    </resultMap>

    <select id="selectPointByUserId" resultMap="PointMap" parameterType="long">
        SELECT
            point_id
          , user_id
          , point
          , reg_date
          , upd_date
        FROM point
        WHERE user_id = #{userId}
    </select>

    <insert id="insertPoint" parameterType="com.jojo.ecommerce.domain.model.Point" useGeneratedKeys="true" keyProperty="pointId">
        INSERT INTO point (
            user_id
          , point
          , request_id
          , reg_date
        ) VALUES (
            #{userId}
          , #{point}
          , #{requestId}
          , NOW()
        )
    </insert>

    <update id="updatePoint" parameterType="com.jojo.ecommerce.domain.model.Point">
        UPDATE point
        SET
            point = #{point}
          , request_id = #{requestId}
          , upd_date = NOW()
        WHERE user_id = #{userId}
    </update>

    <select id="countPointByUserIdAndRequestId" resultType="int" parameterType="com.jojo.ecommerce.domain.model.Point">
        SELECT COUNT(1)
        FROM point
        WHERE user_id = #{userId}
        AND request_id = #{requestId}
    </select>

    <insert id="insertPointCharge" parameterType="com.jojo.ecommerce.domain.model.Point">
        INSERT INTO point_charge (
            user_id
          , request_id
          , point
          , reg_date
        )
        VALUES (
            #{userId}
          , #{requestId}
          , #{point}
          , NOW()
        )
    </insert>

    <update id="upsertAndAddPoint" parameterType="com.jojo.ecommerce.domain.model.Point">
        INSERT INTO point (
            user_id
          , point
          , reg_date
        )
        VALUES (
            #{userId}
          , #{point}
          , NOW()
        )
        ON DUPLICATE KEY UPDATE
            point = point + #{point}
          , upd_date = NOW()
    </update>

</mapper>
